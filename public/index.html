<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Honest25-AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen flex flex-col p-6">
    <div class="max-w-2xl mx-auto flex-1 w-full">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-blue-500">Honest25-AI</h1>
            <button id="clearBtn" class="text-xs bg-zinc-800 px-3 py-1 rounded hover:bg-zinc-700">Clear Chat</button>
        </header>
        <div id="chat" class="space-y-4 overflow-y-auto mb-24" style="height: calc(100vh - 200px);"></div>
        <div class="fixed bottom-6 left-0 right-0 max-w-2xl mx-auto px-6">
            <div class="flex gap-2">
                <input id="input" class="flex-1 p-3 bg-zinc-900 border border-zinc-800 rounded-lg focus:border-blue-500 outline-none" placeholder="Ask Honest25-AI...">
                <button id="sendBtn" class="bg-blue-600 px-6 py-2 rounded-lg font-bold hover:bg-blue-700">Send</button>
            </div>
            <p id="status" class="text-xs text-zinc-500 mt-2 text-center"></p>
        </div>
    </div>
    <script>
        let messages = []; // New: Persist chat history
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const status = document.getElementById('status');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');

        async function sendMessage() {
            const query = input.value.trim();
            if (!query) return;
            appendMessage('user', query);
            input.value = '';
            status.innerText = 'Honest25 is thinking...'; // New: Typing indicator
            sendBtn.disabled = true;

            messages.push({ role: 'user', content: query });

            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages }),
            });

            const reader = res.body.getReader();
            let reply = '';
            let modelUsed = '';
            appendMessage('assistant', ''); // Placeholder for streaming

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = new TextDecoder().decode(value);
                const lines = chunk.split('\n\n').filter(l => l.startsWith('data: '));
                for (const line of lines) {
                    const data = JSON.parse(line.slice(6));
                    if (data.content) {
                        reply += data.content;
                        updateLastMessage(reply);
                    }
                    if (data.done) {
                        modelUsed = data.modelUsed;
                        messages.push({ role: 'assistant', content: reply });
                    }
                }
            }

            status.innerText = `Replied using: ${modelUsed.split('/').pop().replace(':free', '')}`;
            sendBtn.disabled = false;
            scrollToBottom();
        }

        function appendMessage(role, content) {
            const div = document.createElement('div');
            div.className = role === 'user' ? 'text-right' : 'bg-zinc-900 p-4 rounded-lg';
            div.innerHTML = `<b>${role === 'user' ? 'You' : 'Honest25-AI'}:</b> ${content}`;
            chat.appendChild(div);
        }

        function updateLastMessage(content) {
            const last = chat.lastChild;
            last.innerHTML = `<b>Honest25-AI:</b> ${content}`;
        }

        function scrollToBottom() {
            chat.scrollTop = chat.scrollHeight;
        }

        function clearChat() {
            messages = [];
            chat.innerHTML = '';
            status.innerText = '';
        }

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        clearBtn.addEventListener('click', clearChat);
    </script>
</body>
</html>
